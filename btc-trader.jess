; ======== 
; rulesets 
; ========

(defrule increase-risk-position
  ;(> slope 10%)
  ; and
  ;(cash-available)
  =>
  ; todo get global avail var w/ wallet
  ; (assert (trade(order buy) (amount (get-cash-available * 0.1
)

(defrule decrease-risk-position
  ;(< slope 10%)
  =>
  (assert (order buy))
)

;(defrule calc-slope
 ; ...) 
;(defrule [or deffunc?] manageRisk param: riskPercentage
  ;;; using  10% riskPercentage
  ; if slope >= 10% buy more 
  ; if slope <= -10% exit position
  ; if -10% < slope < 10% hold position
  ; ... )

; ======== 
; templates
; ========
(deftemplate cryptocurrency
  (slot name)
  (slot symbol))
(deftemplate cryptocurrencyTimeSeriesEntry
  (slot symbol)
  (slot timestep)
  (slot openPrice)
  (slot closePrice))
(deftemplate xy_point
  (slot timestep)
  (slot price))
(deftemplate cryptocurrencyMomentum
  (slot symbol)
  (slot slope))
(deftemplate position 
  (slot symbol)
  (slot amount)
  (slot costbasis))

; ==========
; functions
; ==========

; Read in raw data
(deffunction parseInput (?csvFile)
  (import java.io.*)
  (bind ?file nil)
  (try
    (bind ?file
      (new BufferedReader
        (new java.io.FileReader ?csvFile)))
    (while (neq nil (bind ?line (?file readLine)))
      (bind ?idx 0)
      (bind ?strVal (new java.lang.String ?line))
      (bind ?firstComma (+ (call ?strVal indexOf ",") 1))
      (bind ?pointInTime (call ?strVal substring 0 (- ?firstComma 1)))
      (bind ?secondComma (+ (call ?strVal indexOf "," ?firstComma) 1))
      (bind ?openPrice (call ?strVal substring ?firstComma (- ?secondComma 1)))
      (bind ?closePrice (call ?strVal substring ?secondComma))
      (bind ?factid (assert (cryptocurrencyTimeSeriesEntry (symbol "BTC") (timestep ?pointInTime) (openPrice ?openPrice) (closePrice ?closePrice))))
      (bind ?idx (+ ?idx 1))
      (calc-slope ?factid ?idx))
   catch
    (printout t "Error processing file" crlf)
   finally
    (if (neq nil ?file) then
        (?file close))))

(deffunction calc-slope (?tseid ?idx)
  (if (neq (fact-id 0) ?tseid) then
    (if (neq (fact-id 1) ?tseid) then
      (if (neq (fact-id 2) ?tseid) then
          (bind ?x (fact-slot-value ?tseid openPrice))
          (bind ?y (fact-slot-value ?tseid closePrice))
          (bind ?slope (/ (- ?y ?x) 1))
          (printout t "slope: " ?slope crlf)
          (printout t "dealing w/ real tse: " ?tseid crlf)))))


; ==========
; "main"
; ==========
(reset)
(assert (cryptocurrency (name "Bitcoin") (symbol "BTC") ))
(bind ?cash 100000)
(parseInput "btc_price_data.csv")
; extra line only for readability
(retract 2)
(facts)
;(printout t "origin: " ?origin crlf)

;(defrule increase-position-if-positive-momentum
;  "If slope is suffeciently positive, buy."
;  ?buy <- (positive-slope)
;  =>
;  (increase-position)
;  (retract ?buy))

